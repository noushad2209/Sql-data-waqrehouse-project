/*
Purpose: Create/Alter procedure to load silver tables from bronze sources

WARNING: Do NOT run this script on PRODUCTION without review and a backup.


-- Helpful notes:
-- 1) To run this procedure after creating it: uncomment and run:  -- EXEC silver.load_silver;
-- 2) To set the target DB before running: uncomment and update: -- USE [YourDatabase];
*/

--Exec silver.load_silvers
create or alter PROCEDURE silver.load_silver AS
BEGIN
	DECLARE @batch_start_time datetime,@batch_end_time datetime

	print '=================='
	print 'Loading crm Tables'
	print'==================='

	set @batch_start_time = GETDATE()
	TRUNCATE TABLE silver.crm_cust_info;
	print 'Cleansing silver.crm_cust_info'
	insert into silver.crm_cust_info(
		cst_id,
		cst_key,
		cst_fisrtname,
		cst_lastname,
		cst_matial_status,
		cst_gndr,
		cst_create_date
	)
	select
	cst_id, 
	cst_key, 
	trim(cst_fisrtname) as cst_fisrtname, 
	trim(cst_lastname) as cst_lastname, 
	case cst_matial_status when 
		upper(trim('S')) then  'Single'
		when upper(trim('M')) then  'Married'
		else 'n/a'
	end as cst_matial_status,
	case cst_gndr when
		upper(Trim('M')) then 'Male'
		when upper(trim('F')) then 'Female'
		else 'n/a'
	end as cst_gndr,
	cst_create_date
	from(
		select *,
		row_number() over(partition by cst_id order by cst_create_date desc) as flag 
		from bronze.crm_cust_info 
	)t where flag=1 and cst_id is not null

	TRUNCATE TABLE silver.crm_prd_info
	print 'Cleansing '
	insert into silver.crm_prd_info(
		prd_id,
		cat_id,
		prd_key,
		prd_nm,
		prd_cost,
		prd_line,
		prd_start_dt,
		prd_end_date
	)
	select
	prd_id,
	replace(substring(prd_key,1,5),'-','_') cat_id,
	substring(prd_key,7,len(prd_key)) prd_key,
	prd_nm,
	ISNULL(prd_cost,0) prd_cost,
	case prd_line 
		when upper(trim('M')) then 'Mountains'
		when upper(trim('s')) then 'other sales'
		when upper(trim('R')) then 'Roads'
		when upper(trim('T')) then 'Touring'
		else 'n/a'
	end as prd_line,
	prd_start_dt,
	lead(prd_start_dt-1) over(partition by prd_key order by prd_key) as Prd_end_dt
	from bronze.crm_prd_info;


	TRUNCATE TABLE silver.crm_sales_details
	print 'Cleansing silver.crm_sales_details'
	insert into silver.crm_sales_details( 
		   sls_ord_num
		  ,sls_prd_key
		  ,sls_cust_id
		  ,sls_order_dt
		  ,sls_ship_date
		  ,sls_due_date
		  ,sls_sales
		  ,sls_qunatity
		  ,sls_price
	)


	select
	sls_ord_num,
	sls_prd_key,
	sls_cust_id,
	case when sls_order_dt =0 or len(sls_order_dt) !=8 then null
		 else cast(cast(sls_order_dt as varchar)as date)
	end as sls_order_dt,

	case when sls_ship_date =0 or len(sls_ship_date) !=8 then null
		 else cast(cast(sls_ship_date as varchar)as date)
	end as sls_ship_dt,

	case when sls_due_date =0 or len(sls_due_date) !=8 then null
		 else cast(cast(sls_due_date as varchar)as date)
	end as sls_due_dt,

	case when sls_sales is null or sls_sales<=0 or sls_sales != sls_qunatity*abs(sls_price)
		then sls_qunatity*(nullif(sls_price,0))
		else sls_sales
	end as sls_sales,
	sls_qunatity,
	case when sls_price is null or sls_price<=0 
		then (sls_sales)/(nullif(sls_qunatity,0))
		else sls_price
	end as sls_price
	from bronze.crm_sales_details

	set @batch_end_time=GETDATE()
	print '====================='
	print 'Cleansing Duration for CRM Tables ' + cast(datediff(second,@batch_start_time,@batch_end_time) as nvarchar(50))+'Sec'
	print '====================='
	print '------------------------------------------------'

	print '=================='
	print 'Loading erp Tables'
	print'==================='
	set @batch_start_time = GETDATE()
	TRUNCATE TABLE silver.erp_cust_az12
	print 'Cleansing silver.erp_cust_az12'
	insert into silver.erp_cust_az12(
		cid,
		bdate,
		gen
	)

	select
	case when cid like 'NAS%' then substring(cid,4,len(cid))
		else cid
	end as cid,
	case when bdate>getdate() then null
		else bdate
	end as bdate,
	case when upper(trim(gen)) in ('M','Male') then 'Male'
		when upper(trim(gen)) in ('F','Female') then 'Female'
		else 'n/a'
	end as gen
	from bronze.erp_cust_az12


	TRUNCATE TABLE silver.erp_loc_a101
	print 'Cleansing silver.erp_loc_a101'
	insert into silver.erp_loc_a101(
		cid,
		cntry
		)
	select
	replace(cid,'-','') cid,
	case when trim(cntry) ='DE' then 'Germany'
		when trim(cntry) in ('US','USA') then 'United States'
		when trim(cntry) = '' or trim(cntry) is null then 'n/a'
		else trim(cntry)
	end as cntry
	from bronze.erp_loc_a101


	TRUNCATE TABLE silver.erp_px_cat_g1v2
	print 'Cleansing silver.erp_px_cat_g1v2'
	insert into silver.erp_px_cat_g1v2(
		id,cat,subcat,maintenance
	)
	select 
	id,
	cat,
	subcat,
	maintenance
	from bronze.erp_px_cat_g1v2
	set @batch_end_time = GETDATE()
	print '====================='
	print 'Cleansing Duration for ERP Tables ' + cast(datediff(second,@batch_start_time,@batch_end_time) as nvarchar(50))+'Sec'
	print '====================='

end
